{"title":"IPsec & GRE VPN","markdown":{"yaml":{"title":"IPsec & GRE VPN","format":{"html":{"toc":true,"toc-depth":5,"css":"styles.css"}},"editor_options":{"markdown":{"mode":"gfm"}}},"headingText":"General Notes","containsRefs":false,"markdown":"\n\n- **GRE**\n\t- Stands for Generic Route Encapsulation\n\t- Tunneling method that can tunnel many different protocols inside GRE header\n\t- Used as default encapsulation method for Cisco tunnel interfaces\n\t- IP protocol type **47** used in IP header\n- **Security features of IPSec**\n\t- **Data origin authentication**\n\t\t- Verifying where packet came from\n\t- **Data integrity**\n\t\t- Ensuring packet wasn't changed in transit\n\t- **Confidentiality**\n\t\t- Encryption, preventing packet from being intercepted and read\n\t\t- Prevented by limited allowed window\n\t- Confidentiality is the mainly thought-of core feature\n- IPSec uses symmetric key encryption\n- Point-to-point tunnels in almost all cases, GETVPN can be P2MP \n- Tunnel keys dynamically negotiated through IKE\n- IKEv2 is superior but not supported by all platforms\n\n##### Phases\n- Phase one establishes ISAKMP SA, secure tunnel to negotiate phase two through\n- Phase two establishes IPsec SA, tunnel used to protect actual data traffic\n- **In Phase 1:**\n\t- Authentication either PSK (Pre-shared key) or certificate based\n\t- DH^[Diffie Hellman - asymmetric key algorithm used for IPsec, SSL, SSH and others. Peers create public and private keys, exchange public key and generate symmetric key (shared secret) with their own private key and peer's public key[[DH.png|See Example]]] used to exchange crypto keys\n\t\t- Higher DH group number is more secure\n\t- Encryption algorithms used to protect traffic\n\t\t- Possibilities include DES, 3DES, AES-128, AES-256, etc\n\t- Hash algorithm used to ensure packet wasn't modified in transit\n\t\t- IKEv1 supports MD5, SHA-1\n\t- Tunnel lifetime is negotiated\n\t- IKE parameters *must match* in order for phase 1 to complete successfully\n\t- Main mode and aggressive mode both options for completing this step\n\t\t- Main mode preferred as aggressive has security issues\n- **In Phase 2, following are negotiated:**\n\t- Security protocol\n\t\t- ESP (Encapsulating Security Payload) or AH (Authentication Header)\n\t\t- AH does not support encryption, rarely used\n\t- Encapsulation modes\n\t\t- Tunnel or transport\n\t\t- Tunnel adds new IP header, used for actually tunneling traffic\n\t\t- Transport mode used for host-to-host applications or combined with GRE which does the tunneling itself\n\t- Encryption (used for actual data traffic, not just tunnel)\n\t\t- DES, 3DES, AES-128, AES-256, etc\n\t- Authentication (hashing)\n\t\t- MD5, SHA, etc\n\t- Combination of the above called IPsec **Transform Set**\n\t- Only performed in QM (quick mode)\n- UDP 500 (ISAKMP), 4500 (NAT-T) are ports used to establish control plane\n\t- 4500 is only used with NAT-T^[NAT-Traversal add an additional UDP header which encapsulates the IPsec ESP header. Since this header is not encrypted it allows NAT without breaking packet integrity requirements of IPsec [[NAT-T.png|See Example]]]\n- IPsec data plane uses IP protocol **50** (ESP), **51** (AH) in the IP header\n\n---\n\n#### Useful show/debug commands\n- **Phase 1:**\n\t- `show crypto isakmp sa` - should show **QM_IDLE** as state and status as **ACTIVE**\n\t- `debug crypto isakmp`, or `debug crypto condition peer ipv4 <IP>` to debug for one specific peer\n- **Phase 2:**\n\t- `show crypto ipsec sa [<peer IP>`]\n\t- `debug crypto ipsec`\n\t\n---\n\n#### Config\n\n##### Crypto Profile IPSec Config w/ IKEv1 (with & without GRE)\n```   \ninterface Tunnel0  \n ip address <ip & mask>\n tunnel source <ip>\n tunnel destination <ip>\n   \ncrypto isakmp policy 10\n encryption aes 256\n hash md5\n authentication pre-share\n group 14\n lifetime 3600 \n !\ncrypto isakmp key <PSK> address <remote outside interface IP with subnet mask>\n !\ncrypto ipsec transform-set <ts-name> esp-3des esp-md5-hmac\n mode transport\n!mode tunnel if using VTI\n\ncrypto ipsec profile <profile-name>\n set transform-set <ts-name>\n   \ninterface Tunnel0\n tunnel protection ipsec profile <profile-name>\n ip mtu 1400\n ip tcp adjust-mss 1360\n!optionally can define tunnel mode as ipsec to bypass GRE and use VTI - 'tunnel mode ipsec ipv4'\n!note that routing through tunnel must exist for ipsec sa to form - routing not included in config\n!can do underlay and overlay routing protocols, static routing, front door vrfs, many options\n```\n\n##### Crypto Profile IPSec Config w/ IKEv2 (with & without GRE)\n```   \ninterface Tunnel0  \n ip address <ip & mask>\n tunnel source <ip>\n tunnel destination <ip>\n    \ncrypto ikev2 keyring <keyring-name>\n peer ANY\n address 0.0.0.0 0.0.0.0 ! any host for DMVPN, specific host for site-to-site\n pre-shared-key <psk>\n!\ncrypto ikev2 profile <ike-prof-name>\n match identity remote address 0.0.0.0 ! any host for DMVPN, specific host for site-to-site\n authentication remote pre-share\n authentication local pre-share\n keyring local <keyring-name>\n!\ncrypto ipsec transform-set <ts-name> esp-aes 256 esp-sha-hmac\n mode transport\n !mode tunnel if using VTI\n!\ncrypto ipsec profile <profile-name>\n set transform-set <ts-name>\n set ikev2-profile <ike-prof-name>\n!\ninterface Tunnel0\n tunnel protection ipsec profile <profile-name>\n !optionally can define tunnel mode as ipsec to bypass GRE and use VTI - 'tunnel mode ipsec ipv4'\n\n!note that routing through tunnel must exist for ipsec sa to form - routing not included in config\n!can do underlay and overlay routing protocols, static routing, front door vrfs, many options\n```\n\n##### Crypto Map IPSec Config w/ IKEv1 (with GRE)\n```   \ninterface Tunnel0  \n ip address <ip & mask>\n tunnel source <ip>\n tunnel destination <ip>\n ip mtu 1400\n ip tcp adjust-mss 1360\n   \ncrypto isakmp policy 10\n encryption aes 256\n hash md5\n authentication pre-share\n group 14\n lifetime 180 \n !\ncrypto isakmp key <PSK> address <remote outside interface IP with 32 bit subnet mask>\n !\ncrypto ipsec transform-set <ts-name> esp-3des esp-md5-hmac\n mode transport\n !\naccess-list 120 permit gre host <local outside interface ip> host <remote outside interface IP>\n   \ncrypto map <cm-name> 10 ipsec-isakmpÂ   \n set peer <ip>\n set transform-set <ts-name> \n match address 120  \n   \ninterface Ethernet0/0   \n crypto map <cm-name>\n```\n\n##### See DMVPN page for details on DMVPN IPsec config "},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","filters":["quarto"],"toc":true,"toc-depth":5,"css":["styles.css"],"output-file":"IPsec & GRE VPN.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.335","theme":"solar","fontsize":"1.1em","monofontcolor":"rgb(185, 143, 13)","monobackgroundcolor":"rgb (185, 143, 13)","code-block-bg":true,"code-block-border-left":true,"code-copy":true,"title":"IPsec & GRE VPN","editor_options":{"markdown":{"mode":"gfm"}}},"extensions":{"book":{"multiFile":true}}}}}